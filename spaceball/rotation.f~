      subroutine rotation(atomx,atomy,atomz,
     & nres,nat,na,rep)
      
      implicit none
      real*4, dimension(nres,nat) :: atomx,atomy,atomz
      integer*4, dimension(nres) :: na
      real*4 pi,xp,yp,zp,x,y,z,r,theta,phi,rho,t,f,tym
      integer*4 i,j,at_numb,nres,nat,rep
      character*1 o1,o2,o3,ask_rot

       !write(*,*)'natR',nat,nres
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!      
      ask_rot='Y'
      o1='X'
      o2='Y'
      o3='Z'
      theta=rand(0)+0.1!(rep)+0.1
      phi=rand(0)+0.1!(30*rep)+0.1
      rho=rand(0)+0.1!(40*rep)+0.1
      !write(*,*)theta,phi,rho
      !write(*,*)phi
      !write(*,*)rho
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!      
      at_numb=0
      xp=0.0
      yp=0.0
      zp=0.0
      pi=2*acos(0d0)

      !write(*,*)'wchodze'
            
      do i=1,nres
       do j=1,na(i)
       !write(*,*)i,j
        xp=xp+atomx(i,j)
        yp=yp+atomy(i,j)
        zp=zp+atomz(i,j)
       !write(*,*)'R',i,j,atomx(i,j),atomy(i,j),atomz(i,j) 
        at_numb=at_numb+1
       enddo
      enddo
        
        !write(*,*)'SM',xp,yp,zp,at_numb
               
       xp=xp/dble(at_numb)
       yp=yp/dble(at_numb)
       zp=zp/dble(at_numb)     
     
      
      if (ask_rot.eq.'Y') then
      
      
      if (o1.eq.'Z') then
      
      do i=1,nres
       do j=1,na(i)
        x=atomx(i,j)
        y=atomy(i,j)
        z=atomz(i,j)
      
      r=sqrt((x-xp)**2+(y-yp)**2+(z-zp)**2) 
         if (r.gt.(1d-5)) then
      
      t=acos((z-zp)/r)
            
         if (((x-xp).gt.(1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !1
      f=atan((y-yp)/(x-xp))
      !write(*,*)'Wszedelem w 1'
      else if (((x-xp).lt.(-1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !2
      f=atan(-(x-xp)/(y-yp))+pi/2
      !write(*,*)'Wszedelem w 2'
      else if (((x-xp).lt.(-1d-5)).and.((y-yp).lt.(-1.0d-5))) then !3
      f=atan((y-yp)/(x-xp))+pi
      !write(*,*)'Wszedelem w 3'
      else if (((x-xp).gt.(1.0d-5)).and.((y-yp).lt.(-1.0d-5))) then !4
      f=atan(-(x-xp)/(y-yp))+3*pi/2
      !write(*,*)'Wszedelem w 4'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).gt.(1d-5))) then!5
      f=pi/2
      !write(*,*)'Wszedelem w 5'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).lt.(-1d-5))) then!6
      f=3*pi/2
      !write(*,*)'Wszedelem w 6'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).lt.(-1d-5))) then!7
      f=pi
      !write(*,*)'Wszedelem w 7'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).gt.(1d-5))) then  !8
      f=0d0
      !write(*,*)'Wszedelem w 8'
         endif        
      
      atomx(i,j)=r*sin(t)*cos(f+theta)+xp
      atomy(i,j)=r*sin(t)*sin(f+theta)+yp
      atomz(i,j)=r*cos(t)+zp
      
      else
      atomx(i,j)=x
      atomy(i,j)=y
      atomz(i,j)=z
         endif 
      enddo
      enddo
      
      
      
      
      
      else if (o1.eq.'Y') then
      
      
      tym=yp
      yp=zp
      zp=tym
      
      do i=1,nres
       do j=1,na(i)
        x=atomx(i,j)
        y=atomz(i,j)
        z=atomy(i,j)
      
      
      r=sqrt((x-xp)**2+(y-yp)**2+(z-zp)**2) 
         if (r.gt.(1d-5)) then
      
      t=acos((z-zp)/r)
            
         if (((x-xp).gt.(1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !1
      f=atan((y-yp)/(x-xp))
*      write(*,*)'Wszedelem w 1'
      else if (((x-xp).lt.(-1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !2
      f=atan(-(x-xp)/(y-yp))+pi/2
*      write(*,*)'Wszedelem w 2'
      else if (((x-xp).lt.(-1d-5)).and.((y-yp).lt.(-1.0d-5))) then !3
      f=atan((y-yp)/(x-xp))+pi
*      write(*,*)'Wszedelem w 3'
      else if (((x-xp).gt.(1.0d-5)).and.((y-yp).lt.(-1.0d-5))) then !4
      f=atan(-(x-xp)/(y-yp))+3*pi/2
*      write(*,*)'Wszedelem w 4'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).gt.(1d-5))) then!5
      f=pi/2
*      write(*,*)'Wszedelem w 5'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).lt.(-1d-5))) then!6
      f=3*pi/2
*      write(*,*)'Wszedelem w 6'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).lt.(-1d-5))) then!7
      f=pi
*      write(*,*)'Wszedelem w 7'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).gt.(1d-5))) then  !8
      f=0d0
*      write(*,*)'Wszedelem w 8'
         endif        
      
      atomx(i,j)=r*sin(t)*cos(f+theta)+xp
      atomz(i,j)=r*sin(t)*sin(f+theta)+yp
      atomy(i,j)=r*cos(t)+zp
      
      else
      atomx(i,j)=x
      atomy(i,j)=z
      atomz(i,j)=y
         endif 
      enddo
      enddo
      
      
      
      else if (o1.eq.'X') then
      
      
      tym=xp
      xp=zp
      zp=tym
      
      
      do i=1,nres
       do j=1,na(i)
        x=atomz(i,j)
        y=atomy(i,j)
        z=atomx(i,j)
      
      
      r=sqrt((x-xp)**2+(y-yp)**2+(z-zp)**2) 
         if (r.gt.(1d-5)) then
      
      t=acos((z-zp)/r)
            
         if (((x-xp).gt.(1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !1
      f=atan((y-yp)/(x-xp))
*      write(*,*)'Wszedelem w 1'
      else if (((x-xp).lt.(-1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !2
      f=atan(-(x-xp)/(y-yp))+pi/2
*      write(*,*)'Wszedelem w 2'
      else if (((x-xp).lt.(-1d-5)).and.((y-yp).lt.(-1.0d-5))) then !3
      f=atan((y-yp)/(x-xp))+pi
*      write(*,*)'Wszedelem w 3'
      else if (((x-xp).gt.(1.0d-5)).and.((y-yp).lt.(-1.0d-5))) then !4
      f=atan(-(x-xp)/(y-yp))+3*pi/2
*      write(*,*)'Wszedelem w 4'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).gt.(1d-5))) then!5
      f=pi/2
*      write(*,*)'Wszedelem w 5'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).lt.(-1d-5))) then!6
      f=3*pi/2
*      write(*,*)'Wszedelem w 6'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).lt.(-1d-5))) then!7
      f=pi
*      write(*,*)'Wszedelem w 7'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).gt.(1d-5))) then  !8
      f=0d0
*      write(*,*)'Wszedelem w 8'
         endif        
      
      atomz(i,j)=r*sin(t)*cos(f+theta)+xp
      atomy(i,j)=r*sin(t)*sin(f+theta)+yp
      atomx(i,j)=r*cos(t)+zp
      
      else
      atomz(i,j)=x
      atomy(i,j)=y
      atomx(i,j)=z
         endif 
      enddo
      enddo
      
      endif 
      
      
      
      if (o2.eq.'Z') then
      
      do i=1,nres
       do j=1,na(i)
        x=atomx(i,j)
        y=atomy(i,j)
        z=atomz(i,j)
      
      r=sqrt((x-xp)**2+(y-yp)**2+(z-zp)**2) 
         if (r.gt.(1d-5)) then
      
      t=acos((z-zp)/r)
            
         if (((x-xp).gt.(1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !1
      f=atan((y-yp)/(x-xp))
      !write(*,*)'Wszedelem w 1'
      else if (((x-xp).lt.(-1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !2
      f=atan(-(x-xp)/(y-yp))+pi/2
      !write(*,*)'Wszedelem w 2'
      else if (((x-xp).lt.(-1d-5)).and.((y-yp).lt.(-1.0d-5))) then !3
      f=atan((y-yp)/(x-xp))+pi
      !write(*,*)'Wszedelem w 3'
      else if (((x-xp).gt.(1.0d-5)).and.((y-yp).lt.(-1.0d-5))) then !4
      f=atan(-(x-xp)/(y-yp))+3*pi/2
      !write(*,*)'Wszedelem w 4'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).gt.(1d-5))) then!5
      f=pi/2
      !write(*,*)'Wszedelem w 5'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).lt.(-1d-5))) then!6
      f=3*pi/2
      !write(*,*)'Wszedelem w 6'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).lt.(-1d-5))) then!7
      f=pi
      !write(*,*)'Wszedelem w 7'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).gt.(1d-5))) then  !8
      f=0d0
      !write(*,*)'Wszedelem w 8'
         endif        
      
      atomx(i,j)=r*sin(t)*cos(f+phi)+xp
      atomy(i,j)=r*sin(t)*sin(f+phi)+yp
      atomz(i,j)=r*cos(t)+zp
      
      else
      atomx(i,j)=x
      atomy(i,j)=y
      atomz(i,j)=z
         endif 
      enddo
      enddo
      
     
      else if (o2.eq.'Y') then
      
      
      tym=yp
      yp=zp
      zp=tym
      
      do i=1,nres
       do j=1,na(i)
        x=atomx(i,j)
        y=atomz(i,j)
        z=atomy(i,j)      
      
      r=sqrt((x-xp)**2+(y-yp)**2+(z-zp)**2) 
         if (r.gt.(1d-5)) then
      
      t=acos((z-zp)/r)
            
         if (((x-xp).gt.(1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !1
      f=atan((y-yp)/(x-xp))
*      write(*,*)'Wszedelem w 1'
      else if (((x-xp).lt.(-1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !2
      f=atan(-(x-xp)/(y-yp))+pi/2
*      write(*,*)'Wszedelem w 2'
      else if (((x-xp).lt.(-1d-5)).and.((y-yp).lt.(-1.0d-5))) then !3
      f=atan((y-yp)/(x-xp))+pi
*      write(*,*)'Wszedelem w 3'
      else if (((x-xp).gt.(1.0d-5)).and.((y-yp).lt.(-1.0d-5))) then !4
      f=atan(-(x-xp)/(y-yp))+3*pi/2
*      write(*,*)'Wszedelem w 4'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).gt.(1d-5))) then!5
      f=pi/2
*      write(*,*)'Wszedelem w 5'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).lt.(-1d-5))) then!6
      f=3*pi/2
*      write(*,*)'Wszedelem w 6'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).lt.(-1d-5))) then!7
      f=pi
*      write(*,*)'Wszedelem w 7'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).gt.(1d-5))) then  !8
      f=0d0
*      write(*,*)'Wszedelem w 8'
         endif        
      
      atomx(i,j)=r*sin(t)*cos(f+phi)+xp
      atomz(i,j)=r*sin(t)*sin(f+phi)+yp
      atomy(i,j)=r*cos(t)+zp
      
      else
      atomx(i,j)=x
      atomz(i,j)=y
      atomy(i,j)=z
         endif
          
      enddo
      enddo
      
      
      
      else if (o2.eq.'X') then
      
      
      tym=xp
      xp=zp
      zp=tym
      
      do i=1,nres
       do j=1,na(i)
        x=atomz(i,j)
        y=atomy(i,j)
        z=atomx(i,j)      
      
      r=sqrt((x-xp)**2+(y-yp)**2+(z-zp)**2) 
         if (r.gt.(1d-5)) then
      
      t=acos((z-zp)/r)
            
         if (((x-xp).gt.(1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !1
      f=atan((y-yp)/(x-xp))
*      write(*,*)'Wszedelem w 1'
      else if (((x-xp).lt.(-1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !2
      f=atan(-(x-xp)/(y-yp))+pi/2
*      write(*,*)'Wszedelem w 2'
      else if (((x-xp).lt.(-1d-5)).and.((y-yp).lt.(-1.0d-5))) then !3
      f=atan((y-yp)/(x-xp))+pi
*      write(*,*)'Wszedelem w 3'
      else if (((x-xp).gt.(1.0d-5)).and.((y-yp).lt.(-1.0d-5))) then !4
      f=atan(-(x-xp)/(y-yp))+3*pi/2
*      write(*,*)'Wszedelem w 4'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).gt.(1d-5))) then!5
      f=pi/2
*      write(*,*)'Wszedelem w 5'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).lt.(-1d-5))) then!6
      f=3*pi/2
*      write(*,*)'Wszedelem w 6'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).lt.(-1d-5))) then!7
      f=pi
*      write(*,*)'Wszedelem w 7'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).gt.(1d-5))) then  !8
      f=0d0
*      write(*,*)'Wszedelem w 8'
         endif        
      
      atomz(i,j)=r*sin(t)*cos(f+phi)+xp
      atomy(i,j)=r*sin(t)*sin(f+phi)+yp
      atomx(i,j)=r*cos(t)+zp
      
      else
      atomz(i,j)=x
      atomy(i,j)=y
      atomx(i,j)=z
         endif 
      enddo
      enddo
      
      endif
      
      if (o3.eq.'Z') then
      
      do i=1,nres
       do j=1,na(i)
        x=atomx(i,j)
        y=atomy(i,j)
        z=atomz(i,j)      
      
      r=sqrt((x-xp)**2+(y-yp)**2+(z-zp)**2) 
         if (r.gt.(1d-5)) then
      
      t=acos((z-zp)/r)
            
         if (((x-xp).gt.(1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !1
      f=atan((y-yp)/(x-xp))
      !write(*,*)'Wszedelem w 1'
      else if (((x-xp).lt.(-1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !2
      f=atan(-(x-xp)/(y-yp))+pi/2
      !write(*,*)'Wszedelem w 2'
      else if (((x-xp).lt.(-1d-5)).and.((y-yp).lt.(-1.0d-5))) then !3
      f=atan((y-yp)/(x-xp))+pi
      !write(*,*)'Wszedelem w 3'
      else if (((x-xp).gt.(1.0d-5)).and.((y-yp).lt.(-1.0d-5))) then !4
      f=atan(-(x-xp)/(y-yp))+3*pi/2
      !write(*,*)'Wszedelem w 4'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).gt.(1d-5))) then!5
      f=pi/2
      !write(*,*)'Wszedelem w 5'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).lt.(-1d-5))) then!6
      f=3*pi/2
      !write(*,*)'Wszedelem w 6'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).lt.(-1d-5))) then!7
      f=pi
      !write(*,*)'Wszedelem w 7'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).gt.(1d-5))) then  !8
      f=0d0
      !write(*,*)'Wszedelem w 8'
         endif        
      
      atomx(i,j)=r*sin(t)*cos(f+rho)+xp
      atomy(i,j)=r*sin(t)*sin(f+rho)+yp
      atomz(i,j)=r*cos(t)+zp
      
      else
      atomx(i,j)=x
      atomy(i,j)=y
      atomz(i,j)=z
         endif 
      enddo
      enddo
      
      
      
      else if (o3.eq.'Y') then
      
      
      tym=yp
      yp=zp
      zp=tym
      
      do i=1,nres
       do j=1,na(i)
        x=atomx(i,j)
        y=atomz(i,j)
        z=atomy(i,j)
      
      
      r=sqrt((x-xp)**2+(y-yp)**2+(z-zp)**2) 
         if (r.gt.(1d-5)) then
      
      t=acos((z-zp)/r)
            
         if (((x-xp).gt.(1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !1
      f=atan((y-yp)/(x-xp))
*      write(*,*)'Wszedelem w 1'
      else if (((x-xp).lt.(-1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !2
      f=atan(-(x-xp)/(y-yp))+pi/2
*      write(*,*)'Wszedelem w 2'
      else if (((x-xp).lt.(-1d-5)).and.((y-yp).lt.(-1.0d-5))) then !3
      f=atan((y-yp)/(x-xp))+pi
*      write(*,*)'Wszedelem w 3'
      else if (((x-xp).gt.(1.0d-5)).and.((y-yp).lt.(-1.0d-5))) then !4
      f=atan(-(x-xp)/(y-yp))+3*pi/2
*      write(*,*)'Wszedelem w 4'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).gt.(1d-5))) then!5
      f=pi/2
*      write(*,*)'Wszedelem w 5'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).lt.(-1d-5))) then!6
      f=3*pi/2
*      write(*,*)'Wszedelem w 6'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).lt.(-1d-5))) then!7
      f=pi
*      write(*,*)'Wszedelem w 7'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).gt.(1d-5))) then  !8
      f=0d0
*      write(*,*)'Wszedelem w 8'
         endif        
      
      atomx(i,j)=r*sin(t)*cos(f+rho)+xp
      atomz(i,j)=r*sin(t)*sin(f+rho)+yp
      atomy(i,j)=r*cos(t)+zp
      
      else
      atomx(i,j)=x
      atomz(i,j)=y
      atomy(i,j)=z
         endif 
      enddo
      enddo
      
      
      
      else if (o3.eq.'X') then
      
      
      tym=xp
      xp=zp
      zp=tym
      
      do i=1,nres
       do j=1,na(i)
        x=atomz(i,j)
        y=atomy(i,j)
        z=atomx(i,j)      
      
      r=sqrt((x-xp)**2+(y-yp)**2+(z-zp)**2) 
         if (r.gt.(1d-5)) then
      
      t=acos((z-zp)/r)
            
         if (((x-xp).gt.(1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !1
      f=atan((y-yp)/(x-xp))
*      write(*,*)'Wszedelem w 1'
      else if (((x-xp).lt.(-1.0d-5)).and.((y-yp).gt.(1.0d-5))) then !2
      f=atan(-(x-xp)/(y-yp))+pi/2
*      write(*,*)'Wszedelem w 2'
      else if (((x-xp).lt.(-1d-5)).and.((y-yp).lt.(-1.0d-5))) then !3
      f=atan((y-yp)/(x-xp))+pi
*      write(*,*)'Wszedelem w 3'
      else if (((x-xp).gt.(1.0d-5)).and.((y-yp).lt.(-1.0d-5))) then !4
      f=atan(-(x-xp)/(y-yp))+3*pi/2
*      write(*,*)'Wszedelem w 4'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).gt.(1d-5))) then!5
      f=pi/2
*      write(*,*)'Wszedelem w 5'
      else if ((abs(x-xp).lt.(1d-5)).and.((y-yp).lt.(-1d-5))) then!6
      f=3*pi/2
*      write(*,*)'Wszedelem w 6'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).lt.(-1d-5))) then!7
      f=pi
*      write(*,*)'Wszedelem w 7'
      else if ((abs(y-yp).lt.(1d-5)).and.((x-xp).gt.(1d-5))) then  !8
      f=0d0
*      write(*,*)'Wszedelem w 8'
         endif        
      
      atomz(i,j)=r*sin(t)*cos(f+rho)+xp
      atomy(i,j)=r*sin(t)*sin(f+rho)+yp
      atomx(i,j)=r*cos(t)+zp
      
      else
      atomz(i,j)=x
      atomy(i,j)=y
      atomx(i,j)=z
         endif 
      enddo
      enddo
      
      endif
                      
      
! To wylaczylem                  
!      do i=1,num
!      if (centerx.le.centx) then
!      atom(i,1)=atom(i,1)+abs(centerx-centx)
!      else
!      atom(i,1)=atom(i,1)-abs(centerx-centx)
!      endif
!      if (centery.le.centy) then
!      atom(i,2)=atom(i,2)+abs(centery-centy)
!      else
!      atom(i,2)=atom(i,2)-abs(centery-centy)
!      endif
!      if (centerz.le.centz) then
!      atom(i,3)=atom(i,3)+abs(centerz-centz)
!      else
!      atom(i,3)=atom(i,3)-abs(centerz-centz)
!      endif
!      enddo     
      endif

       !write(*,*)'wychodze111'
       write(*,*)'E',atomx(1,1),atomx(nres,1),nres,na(nres)

      return
      end
